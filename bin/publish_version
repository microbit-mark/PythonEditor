#!/bin/bash
set -e
set -u
set -o pipefail

VERSION=$1
NORMALISED_VERSION=$(echo ${VERSION} | sed -e "s/\./-/g")
BUCKET="python-editor-${NORMALISED_VERSION}.microbit.org"

aws configure set preview.cloudfront true

CLOUDFRONT_POLICY=$(mktemp)
sed -e "s/{{NORMALISED_VERSION}}/${NORMALISED_VERSION}/g" cloudfront.tmpl.json > "${CLOUDFRONT_POLICY}"
sed -i '' "s/{{CALLER_REFERENCE}}/$(date +%s)/" ${CLOUDFRONT_POLICY}

echo "Creating cloudfront distribution..."
DOMAIN_NAME=$(aws cloudfront create-distribution --distribution-config "file://${CLOUDFRONT_POLICY}" | jq '.Distribution.DomainName' | sed -e 's/\"//g')
echo "...done"

ROUTE_53_POLICY=$(mktemp)
sed -e "s/{{NORMALISED_VERSION}}/${NORMALISED_VERSION}/g" route53.tmpl.json > "${ROUTE_53_POLICY}"
sed -i '' "s/{{DOMAIN_NAME}}/${DOMAIN_NAME}/" ${ROUTE_53_POLICY}

: ${ROUTE_53_ZONE_ID:=Z1RHL9V3FF5VUG} # ID for microbit.org. hosted zone
echo "Creating subdomain..."
aws route53 change-resource-record-sets --hosted-zone-id ${ROUTE_53_ZONE_ID} --change-batch "file://${ROUTE_53_POLICY}"
echo "...done"
